---
title: "Analisis potenciar trabajo"
author: "Ariana Bard"
date: "`r Sys.Date()`"
lang: "es"
output:
  rmdformats::downcute:
    lightbox: TRUE
    highlight: tango
    toc: 3
    number-sections: TRUE
    code-folding: hide
    code_download: TRUE
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
library(tidyverse)
library(janitor)
library(waffle)
library(plotly)
library(sf)
library(stringr)
library(lubridate)
library(geoAr)
library(ggrepel)
library(gt)
options(scipen=999)
```



```{r}
#titulares por periodo y jurisdiccion (municipio)
total_titulares <- read_csv("https://datosabiertos.desarrollosocial.gob.ar/dataset/d45687c0-f2ba-41d9-9989-0ad9799308ae/resource/c4caa724-dfbb-4aac-bfe7-2169f4154bc5/download/potenciar-trabajo-titulares-activos-2022-10-01.csv")

#titulares por año y jurisdiccion (este parecería no tener sentido si tenes por período). Datos geográficos son del 
# ultimo cobro del titular (se podria mapear)
titulares_ano <- read_csv("https://datosabiertos.desarrollosocial.gob.ar/dataset/d45687c0-f2ba-41d9-9989-0ad9799308ae/resource/c5c925e0-7ce0-41e5-b3ff-8ebb51d4be72/download/potenciar-trabajo-titulares-2022-10-01.csv")

# Mapa argentina y provincia de buenos aires 
#titulares únicos del programa. Este también creo que no tiene mucho sentido. Es del último período
titulares_programa <- read_csv("https://datosabiertos.desarrollosocial.gob.ar/dataset/d45687c0-f2ba-41d9-9989-0ad9799308ae/resource/5d5274f0-f4d5-440a-9781-7fc6df0b4cb2/download/potenciar-trabajo-total-titulares-2022-10-01.csv")

#titulares se pueden sacar datos del perfil de la persona (sexo, edad y municipio)

titulares_personas <- read_csv("data/potenciar-trabajo-listado-titulares-2022-10-01.csv")

# Pagos (Se podría ver desde cuano hasta cuando recibio pagos cada persona).No está el monto solo la fecha de pago y el id

pagos <- read_csv("data/potenciar-trabajo-listado-pagos-titulares-2022-10-01.csv")

# Filtro el monto por potenciar trabajo
montos_vigentes <- read_csv("https://datosabiertos.desarrollosocial.gob.ar/dataset/2fbfb3e2-cd0a-4d1b-ac3b-89326e8e4f9c/resource/6778396e-75f7-4fce-ac65-97d1e5e4525e/download/montos-transferencias-2023-01-01.csv") |> 
  filter(programa == "Potenciar Trabajo")


```

## Perfil de los titulares
Pirámide del país y pirámide de la provincia.


```{r}
titulares_personas |> 
  skimr::skim()
```

### Nacionalidad
```{r}

# Habría que limpiar las nacionalidades 
nacionalidad_resumen <- titulares_personas |> 
  mutate(nacionalidad = tolower(nacionalidad)) |> 
  tabyl(nacionalidad) 

nacionalidad_resumen 


#Guardo
writexl::write_xlsx(nacionalidad_resumen |> 
                      select(-valid_percent) |> 
                      mutate(percent = percent*100) |> 
                      rename("porcentaje" = percent,
                             "total titulares" = n), "bases-para-cyn/nacionalidad_resumen.xlsx")


#Cargo el csv limpio
nacionalidad_resumen_limpio <- read_csv("bases-para-cyn/nacionalidad-resumen-limpio.csv")

total <- sum(nacionalidad_resumen_limpio$`total titulares`)

nacionalidad <- nacionalidad_resumen_limpio |> 
  mutate(nacionalidad = ifelse(nacionalidad == "sin informar", NA, nacionalidad),
         nacionalidad = ifelse(is.na(nacionalidad), "Sin dato", nacionalidad)) |> 
  group_by(nacionalidad) |> 
  summarise(Total = sum(`total titulares`),
            proporcion = (Total/total)*100) |> 
  arrange(desc(proporcion)) 

tabla_nacionalidad <- nacionalidad |> 
  mutate(nacionalidad = ifelse(proporcion < 1, "Otros", nacionalidad)) |> 
  group_by(nacionalidad) |> 
  summarise(Total = sum(Total),
            proporcion = (Total/total)*100) |> 
  arrange(desc(proporcion)) 



perc_counts <- (tabla_nacionalidad$proporcion)
names(perc_counts) <- tabla_nacionalidad$nacionalidad

sum(tabla_nacionalidad$proporcion)

# Graficamos
# 
waffle(perc_counts) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(title = "Porcentaje de titulares por género")

#No tiene sentido mostrarlo 
writexl::write_xlsx(nacionalidad, "bases-para-cyn/titulares_x_nacionalidad.xlsx")

```

El 86% de los titulares es Argentino. El 4.7% no tiene información sobre la nacionalidad

<!-- Habría que limpiarlo. No tiene sentido usarlo -->

### Género y sexo

```{r}
# Sexo

base_sexo <- titulares_personas |> 
  mutate(genero = ifelse(is.na(genero), sexo, genero),
         genero =ifelse(genero == "F", "Mujer", ifelse(genero == "M", "Varón", genero)))

# titulares_personas |> 
#   tabyl(sexo) |> 
#   kableExtra::kable()


# Genero
base_sexo |> 
  tabyl(genero) |> 
  arrange(desc(n))   %>%
  adorn_totals |> 
  mutate(percent = print(paste(round(percent*100,2), "%"))) |> 
  rename(
    "Cantidad" = n,
    "Porcentaje" = percent,
    "Género" = genero
  ) |> 
  gt() %>%
  tab_header(
    title = "Tabla de Distribución de Género",
    subtitle = "Datos de género y frecuencia"
  ) %>%
  fmt_number(
    columns = c(Cantidad),
    decimals = 0) |> 
  fmt_number(
    columns = c(Porcentaje),
    decimals = 2)



print(paste(2867+1086+721+437, "corresponden a disidencias. Es decir, el", (round(((2867+1086+721+437)/1586676)*100,2)),"%"))

# Aclararle que la distribucion por sexo es tal y los NA los reemplacé por el género
writexl::write_xlsx(base_sexo |> 
                      tabyl(genero) |> 
                      arrange(desc(n))  |> 
                      rename("porcentaje" = percent,
                             "total titulares" = n), "bases-para-cyn/titulares_x_genero.xlsx")

```

```{r}
summary(base_sexo)
```
El rango etario va de los 18 hasta los 72 años

Habría que ver sobre qué año está calculada la edad de las personas si es por el año de ingreso o qué. Y, si son los titulares históricos o los actuales. Si me quedo con el último pago en diciembre de 2022 había 1.362.579. Los gráficos de perfil los hago con la totalidad. 

```{r}
filtrada <- pagos |>
  filter(periodo == max(periodo))



print(paste("El total de titulares que recibieron pago en octubre de 2022 (última fecha en la base) es de:", nrow(filtrada)))

rm(pagos)
```
```{r}

#Edad a 0'
titulares_personas <- titulares_personas |> 
  filter(!is.na(edad)) |> 
  mutate(rango_etario = case_when(
      edad < 25 ~ "18-24",
      edad < 35 ~ "25-34",
      edad < 45 ~ "35-44",
      edad < 55 ~ "45-54",
      edad < 65 ~ "55-64",
      edad >= 65 ~ "65-72"
    ),
    rango_etario = factor(
      rango_etario,
      levels = c("18-24",
                 "25-34",
                 "35-44",
                 "45-54",
                 "55-64",
                 "65-72"
                 )
    )
  )

#esquisse::esquisser(x)




# Armo la piramide

titulares_personas |>
  group_by(rango_etario, sexo) |>
  summarise(N = n()) |>
  mutate(N = ifelse(sexo == "M",-N, N)) |>
  rename(
    "Rango etario" = rango_etario,
    "sexo" = sexo,
    "Cantidad de titulares" = N
  ) |> 
  ggplot() +
  aes(x = `Rango etario`, y = `Cantidad de titulares`, fill = sexo) +
  geom_col() +
  scale_fill_manual(values = c(F = "#b22987",
                               M = "#2987b2")) +
 labs(x = " ", y = " ", title = "Piramide poblacional del Potenciar Trabajo",
      subtitle = "Titulares de Argentina entre el año 2020 y 2022 (en miles)",
      caption = "Fuente: Elaboración propia en base a datos abiertos del Ministerio de Desarrollo Social de la Nación", 
 fill = "Sexo")  +
  coord_flip() +
  ggthemes::theme_pander()+
  theme(legend.position = "right",
    plot.title = element_text(size = 16L, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14L, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 8L),
    axis.title.y = element_text(size = 9L),
    axis.title.x = element_text(size = 9L),
    text = element_text(size =8L)
  ) +
  scale_y_continuous(breaks = c( -50000, -100000, -150000, -200000, -250000, -300000, -350000,0, 50000, 100000, 150000, 200000, 250000, 300000, 350000),
                     labels = c(50, 100, 150, 200, 250, 300, 350,0, 50, 100, 150, 200, 250, 300, 350),
                     limits = c(-350000,350000)
                    ) 

ggsave("graficos/piramide-argentina.png")
```
### Provincia de buenos aires

```{r}

#Piramide de la provincia de buenos aires
titulares_pba <- titulares_personas |>
  filter(provincia_id == "06") |> 
  group_by(rango_etario, sexo) |>
  summarise(N = n()) |>
  mutate(N = ifelse(sexo == "M",-N, N)) |>
  rename(
    "Rango etario" = rango_etario,
    "sexo" = sexo,
    "Cantidad de titulares" = N
  ) 

titulares_pba |> 
  ggplot() +
  aes(x = `Rango etario`, y = `Cantidad de titulares`, fill = sexo) +
  geom_col() +
  scale_fill_manual(values = c(F = "#b22987",
                               M = "#2987b2")) +
 labs(x = " ", y = " ", title = "Piramide poblacional del Potenciar Trabajo",
      subtitle = "Titulares de Buenos Aires entre el año 2020 y 2022 (en miles)",
      caption = "Fuente: Elaboración propia en base a datos abiertos del Ministerio de Desarrollo Social de la Nación", 
 fill = "Sexo")  +
  coord_flip() +
  ggthemes::theme_pander()+
  theme(legend.position = "right",
    plot.title = element_text(size = 16L, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14L, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 8L),
    axis.title.y = element_text(size = 9L),
    axis.title.x = element_text(size = 9L),
    text = element_text(size =8L)
  ) +
  scale_y_continuous(breaks = c( -50000, -100000, -150000, -200000, 0, 50000, 100000, 150000, 200000),
                     labels = c(50, 100, 150, 200, 0, 50, 100, 150, 200),
                     limits = c(-200000,200000)
                    ) 
ggsave("graficos/piramide-baires.png")

```

```{r}
#Modifico errores de nombres
titulares_personas <- titulares_personas |>
  mutate(provincia = ifelse(provincia == "CÃ³rdoba", "Córdoba",
                            ifelse(provincia == "Entre RÃ­os","Entre Ríos",
                                   ifelse(provincia == "TucumÃ¡n", "Tucumán", provincia)))) 

# Creo tabla
titulares_personas |> 
  tabyl(provincia) |> 
  arrange(desc(n)) %>%
  adorn_totals |> 
  mutate(percent = print(paste(round(percent*100,2), "%"))) |> 
  rename(
    "Cantidad" = n,
    "Porcentaje" = percent,
    "Provincia" = provincia
  ) |> 
  gt() %>%
  tab_header(
    title = "Distribución por Provincia",
    subtitle = "Cantidad y Porcentaje de titulares "
  ) %>%
  fmt_number(
    columns = c(Cantidad),
    decimals = 0) |> 
  fmt_number(
    columns = c(Porcentaje),
    decimals = 2)

writexl::write_xlsx(titulares_personas |> 
                      tabyl(provincia) |> 
                      arrange(desc(n))|>
                      mutate(percent = percent*100) |> 
                      rename("porcentaje" = percent,
                             "total titulares" = n), "bases-para-cyn/titulares_x_provincia.xlsx")
```

<!-- Se podría hacer con las proyecciones del indec el % de población que lo recibe para ver porcentualmente cuanto representa -->


## Evolución de los titulares / permanencia en el programa

Titulares por periodo y jurisdicción gráfico lineal

```{r}

# Titulares por periodo y jurisdicción gráfico lineal

tit_argentina <- total_titulares |> 
  group_by(periodo) |> 
  summarise(total_titulares = sum(titulares),
            jurisdiccion = "Argentina") 

df_tendencia <- total_titulares |> 
  filter(provincia_id == "06") |> 
  group_by(periodo) |> 
  summarise(total_titulares = sum(titulares),
            jurisdiccion = "Buenos Aires") |> 
  full_join(tit_argentina)

library(scales)

ggplot(df_tendencia) +
  aes(x = periodo, y = total_titulares, colour = jurisdiccion) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette = "Set2",
                     direction = 1) +
  labs(
    x = " ",
    y = " ",
    title = "Evolución de la cantidad de titulares ",
    subtitle = "Del total del país y de la Provincia de Buenos Aires (2020-2022)",
    caption = "Fuente: Elaboración propia en base a datos abiertos del MDSN",
    color = "Jurisdicción"
  ) +
  ggthemes::theme_pander() +
  theme(
    legend.position = "top",
    plot.title = element_text(size = 15L, face = "bold",
                              hjust = 0.5),
    plot.subtitle = element_text(size = 14L, face = "italic", hjust = 0.5)
  ) +
  scale_x_date(date_labels = "%b-%y", date_breaks = "3 months") +
  scale_y_continuous(labels = comma)

ggsave("graficos/linea.png")
```




3- Ubicando a los titulares a nivel nacional y provincial.
Base Titulares por periodo y jurisdicción 

```{r}
rm(base_sexo, df_tendencia, filtrada, nacionalidad, nacionalidad_resumen, nacionalidad_resumen_limpio, tabla_nacionalidad, titulares_pba)

#Hay un error de  nombre o codificacion en santiago del estero 

writexl::write_xlsx(titulares_ano |> 
                      filter(year(periodo) == 2022), "bases-para-cyn/tot_titulares.xlsx")

# Armo el grafico de titulares totales
 
mapa_provincia <- titulares_ano |>
  mutate(ano = year(periodo)) |> 
  group_by(provincia_id, ano) |> 
  summarise(tot_titulares= sum(titulares))

mapa_provincia <- mapa_provincia |>
  group_by(ano) |> 
  mutate(tot_prop = (tot_titulares/sum(tot_titulares))*100)

# Armo una tabla 

# Vectores con nombres de provincias y códigos
nombres_provincias <- c(
  "Ciudad Autónoma de Buenos Aires",
  "Buenos Aires",
  "Catamarca",
  "Córdoba",
  "Corrientes",
  "Chaco",
  "Chubut",
  "Entre Ríos",
  "Formosa",
  "Jujuy",
  "La Pampa",
  "La Rioja",
  "Mendoza",
  "Misiones",
  "Neuquén",
  "Río Negro",
  "Salta",
  "San Juan",
  "San Luis",
  "Santa Cruz",
  "Santa Fe",
  "Santiago del Estero",
  "Tucumán",
  "Tierra del Fuego, Antártida e Islas del Atlántico Sur"
)

provincia_id <- c(
  "02", "06", "10", "14", "18", "22", "26", "30", "34", "38", "42", "46",
  "50", "54", "58", "62", "66", "70", "74", "78", "82", "86", "90", "94"
)

tabla_cod <- data.frame(provincia_id,nombres_provincias)

mapa_provincia <- mapa_provincia |> 
  left_join(tabla_cod)

tabla <- mapa_provincia |> 
  select(-provincia_id) |> 
  pivot_wider(names_from = ano, values_from = c(tot_titulares, tot_prop)) |> 
  rename("Provincias"= nombres_provincias,
         "Porcentaje 2020" = tot_prop_2020,
         "Porcentaje 2021" = tot_prop_2021,
         "Porcentaje 2022" = tot_prop_2022) |> 
  adorn_totals() 

tabla |> 
  kableExtra::kable()

writexl::write_xlsx(tabla, "bases-para-cyn/titularesxprovinciayano.xlsx")




```


```{r}
# Traigo el mapa de argentina con provincias
mapa_arg <- get_geo("ARGENTINA", level = "provincia") |> 
  rename("provincia_id" = codprov_censo)

# Uno con el calculo anterior
mapa <- mapa_arg |> 
  left_join(mapa_provincia) |> 
  filter(ano %in% c(2020, 2022))

# Mapa total de titulares por jurisdicción 

ggplot(mapa) +
  geom_sf(aes(fill = tot_prop)) + 
  geom_sf_text(
    aes(label = paste0(tot_prop, "%")),
    size = 1.8,
    face = "bold",
    colour = "black",
    hjust = 0.5
  ) +
  scale_fill_viridis_c(option = "mako", direction = -1) +
  ggthemes::theme_pander() +
  labs(title = "Porcentaje de titulares por provincia",
       subtitle = "sobre el total de titulares en 2022 ",
    fill = "Proporción") +
  theme(plot.title = element_text(size = 16L, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14L, face = "italic", hjust = 0.5)
  ) +
  facet_wrap(vars(ano))

ggsave("graficos/mapa-porc-titulares.png")


```

Vamos a usar la proyecciones de indec para 2022

```{r}
poblacion_indec <- read_csv("data/resultado.csv")

poblacion <- poblacion_indec |> 
  filter(!juri == "01") |> 
  filter(ano == 2022 | ano == 2020) |> 
  filter(sexo_nombre == "Ambos sexos") |>
  group_by(ano,juri, juri_nombre) |> 
  summarise(poblacion = sum(poblacion)) |> 
  rename("provincia_id" = juri)



# Armamos la proporción de titulares sobre la población proyectada
mapa_provincia_pob <- mapa_provincia |>
  filter(ano %in% c(2020, 2022)) |> 
  left_join(poblacion) |> 
  group_by(ano, provincia_id) |> 
  mutate(prop_ponlacional = (tot_titulares/poblacion))


mapa_provincia_pob$prop_ponlacional <- round(mapa_provincia_pob$prop_ponlacional*100,2)

#guardo excel)*
writexl::write_xlsx(mapa_provincia_pob, "bases-para-cyn/tot_titulares_provincia_indec.xlsx")
#Uno con el mapa 
mapa_pob <- mapa_arg |> 
  left_join(mapa_provincia_pob)

ggplot(mapa_pob) +
  geom_sf(aes(fill = prop_ponlacional)) +
  geom_sf_text(
    aes(label = paste0(prop_ponlacional, "%")),
    size = 1.8,
    face = "bold",
    colour = "black",
    hjust = 0.5
  ) +
  scale_fill_viridis_c(option = "plasma",
                       direction = -1,
                       labels = percent_format(scale = 1)) +
  ggthemes::theme_pander() +
  labs(title = "Porcentaje de titulares por provincia",
       subtitle = "En base a proyecciones de INDEC - Año 2022 ",
       fill = "Proporción") +
  theme(
    plot.title = element_text(size = 16L, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14L, face = "italic", hjust = 0.5),
    text = element_text(size = 1)
  ) +
  ylab("") +
  xlab("") +
  facet_wrap(vars(ano))   # Añade scales = "free" para ajustar las escalas de los ejes en cada panel


ggsave("graficos/mapa-porc-titulares-x-poblacion.png")

mapa_pob |> 
  group_by(ano) |> 
  summarise(total =sum(tot_titulares),
            total_pob =sum(poblacion))

```
<!-- tendría que hacerlo con 2020 también y proyecciones de 2020
USAR SCRIPT POR DEPARTAMENTO!! -->

Mapa nacional
Mapa Provincial
ver si hay diferencia para ver si hay dos mapas o no.

